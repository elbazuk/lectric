tinymce.PluginManager.add('filemanager', function(editor) {

	editor.settings.file_browser_callback = filemanager;

	function filemanager_onMessage(event){
					
		if(event.data.sender === 'filemanager'){
			
			tinymce.activeEditor.windowManager.getParams().setUrl(event.data.url);
			tinymce.activeEditor.windowManager.close();

			// Remove event listener for a message from ResponsiveFilemanager
			if(window.removeEventListener){
				window.removeEventListener('message', filemanager_onMessage, false);
			} else {
				window.detachEvent('onmessage', filemanager_onMessage);
			}
			
		}
		
	}
	
	function filemanager (id, value, type, win) {
		
		var width = window.innerWidth-20;
		var height = window.innerHeight-40;
		
		if(width > 1800){
			width=1800;
		}
		
		if(height > 1200){
			height=1200;
		}
		
		if(width>600){
			var width_reduce = (width - 20) % 138;
			width = width - width_reduce + 10;
		}
		
		// Add handler for a message from ResponsiveFilemanager
		if(window.addEventListener){
			window.addEventListener('message', filemanager_onMessage, false);
		} else {
			window.attachEvent('onmessage', filemanager_onMessage);
		}
		
		tinymce.activeEditor.windowManager.open({
			title: 'Filemanager',
			file: '/do/response/filemanager/view/?type='+type,
			width: width,  
			height: height,
			resizable: true,
			maximizable: true,
			inline: 1, 
			}, {
			setUrl: function (url) {
				var fieldElm = win.document.getElementById(id);
				fieldElm.value = editor.convertURL(url);
				if ("createEvent" in document) {
					var evt = document.createEvent("HTMLEvents");
					evt.initEvent("change", false, true);
					fieldElm.dispatchEvent(evt)
				} else {
					fieldElm.fireEvent("onchange")
				}
			}
		});
		
	}
	
});
